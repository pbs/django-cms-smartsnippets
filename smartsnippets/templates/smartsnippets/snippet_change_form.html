{% extends "smartsnippets/plugin_change_form.html" %}
{% load smartsnippets_tags %}


{% if original.snippet.description or original.snippet.documentation_link%}
    {% block extrahead %}
        {{ block.super }}
        <style>
            span.plugin-help-tooltip{
                cursor: help;
            }
            .plugin-help-tooltip{
                float: left;
                margin-right: 5px;
            }
            .plugin-help-tooltip img{
                border: 0;
                width: 20px;
                height: 20px;
            }

            #layout_help_popup{
                position: absolute;
                top:0;
                margin:0 auto;
            }
        </style>
        <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/tipTip.css" />
        <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.tipTip.minified.js"></script>
        <script type="text/javascript">
        //<![CDATA[
        (function($) {
            var LayoutListener = {

                init : function(){
                    if($('#id_snippet').find(":selected").text().match("One Promo")){
                        this.bindChange()
                        this.bindSubmit()
                        this.chooseLayout()
                        this.hideUnnecessaryFields()
                        if($('#layout_help_button')){
                            $('#layout_help_button').click(function(){
                                LayoutListener.createHelpPoopup()
                            })
                        }
                    }
                },
                
                bindChange : function(){
                    var self = this

                    var layoutDropDown = $('#var_layout');
                    
                    layoutDropDown.change(function (e) {
                                                
                        self.chooseLayout()
                    });
                },

                bindSubmit : function(){
                    form = $('#smartsnippetpointer_form')

                    form.submit(function(){
                        LayoutListener.clearHiddenMerlinFields()
                    })
                },

                clearHiddenMerlinFields : function(){

                    var fields = $("tr[class^='section_topic']")
                    fields.each(function(){
                        if(!$(this).is(":visible")){
                            $(this).find("input").each(function(){
                                $(this).attr("value","")
                            })
                        }
                    })  
                },

                hideUnnecessaryFields : function(){
                    var labels = $('label').filter(function(index) { 
                        return $(this).text() == "description" || $(this).text() == "published" 
                    })

                    labels.each(function(elem){
                        $(this).parent().parent().remove()
                    })
                },

                chooseLayout : function(){
                    var fields = $("tr[class^='section_topic']")
                    var selection = $('#var_layout').find(":selected").text()
                    var range = parseInt(selection.charAt(0))
                    
                    if(isNaN(range)){
                        range = 0
                    }

                    for(var i=0; i < fields.length; i++){
                        
                        if (i<range) {
                            fields[i].setAttribute("style","")
                        }else{
                            fields[i].setAttribute("style","display:none")
                        }
                    }
                },

                createHelpPoopup : function(){
                    newwindow = window.open("{{STATIC_URL}}images/explorer-white-promos.png",'Available layouts','height=468,width=826');
                }
            }

            $(document).ready(function(){
                $(".plugin-help-tooltip").tipTip({maxWidth: "250px", delay: 100});

                LayoutListener.init()
                
            });
        })(jQuery);
        //]]>
        </script>
    {% endblock %}
{% endif %}

{% block content_title %}
{% if original.snippet.documentation_link %}
    <a class="plugin-help-tooltip" href='{{original.snippet.documentation_link}}' target='_blank' title='{% if original.snippet.description %}{{original.snippet.description}}<br/><br/>{% endif %}Follow link to see documentation'><img src="{{STATIC_URL}}images/help.png"></a>
{% elif original.snippet.description %}
    <span class="plugin-help-tooltip" title='{{original.snippet.description}}'><img src="{{STATIC_URL}}images/help.png"></span>
{% endif %}
{{ block.super }}
{% endblock%}

{% block top %}
<div style="padding:10px; margin-bottom: 10px; border:1px solid #ccc">
<h3>Preview:</h3>
<hr/><br/>
{{ block.super }}
</div>
{% endblock %}

{% block after_related_objects %}
{{ block.super }}
{% if variables %}
    <fieldset class="module">
        <h2>Smart Snippet Variables</h2>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
            {% for variable in variables %}
                {% render_variable variable %} 
            {% endfor %}
            </tbody>
        </table>
    </fieldset>
{% endif %}

{% endblock %}
